<html>
 
  <head>
    <title>Embedding Elm in HTML!</title>
    <script type="text/javascript" src="http://elm-lang.org/elm-runtime.js"></script>
    <script type="text/javascript" src="/debugger.js"></script>
    <script type="text/javascript" src="build/Main.js"></script>
  </head>
 
  <body>
    <div id="wait">Connecting...</div>
    <div id="game" style="height:100%"></div>
  </body>
 
  <script type="text/javascript">
    var mainDiv = document.getElementById('game');
    var waitDiv = document.getElementById('wait');
    var game;

    mainDiv.hidden = true;

    function startGame(debugging) {
      if (debugging) {
        return Elm.debugFullscreen(Elm.Main, "Main.elm");
      } else {
        return Elm.embed(Elm.Main, mainDiv, { downstream : "" });
      }
    }

    window.onerror = function(msg, file, lineNr) {
       alert(msg + file + lineNr);
       return false;
    }

    mynick = localStorage.getItem("nick");
    if (!mynick) {
       mynick = prompt("Please enter a nick");
       localStorage.setItem("nick", mynick);
    }

    var socket = new WebSocket("ws://84.248.82.156:8001");

    socket.onopen = function () {

      waitDiv.hidden = true;
      mainDiv.hidden = false;
      game = startGame();

      socket.onclose = function () {
        game.dispose();
        mainDiv.hidden = true;
        waitDiv.hidden = false;
        console.log("Connection to server has been lost!");
      }

      socket.onmessage = function (e) {
         var data = JSON.parse(e.data);
         if (data.events) {
            for (i = 0; i < data.events.length; ++ i) {
               console.log("game", data.events[0].event, data.events[0]);
            }
         } else {
            console.log("other ", data);
         }
         game.ports.downstream.send(e.data);
      }

      game.ports.upstream.subscribe(function(e) {
        console.log("out", JSON.parse(e));
        socket.send(e);
      });

      socket.send( '{ "type" : "join", "nick": "' + mynick + '" }' );
    }


  </script>
 
</html>
